// Copyright (C) Microsoft Corporation. All rights reserved.
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.
import"./components/close-button.js";import"./error-page.js";import"./loading-page.js";import{getDeviceType as e,urlQuery as s}from"../common/environment.js";import{LitElement as t,html as i,styleMap as r,ref as o,createRef as h}from"../common/lit.js";import{sendMessage as a,subscribeMessage as n}from"../common/message.js";import{generateUUID as d}from"../common/utils.js";import{AIAssistantRpkeyDict as E,AppState as S,ChatModeClientScopeDict as l,ConsentType as T,ContextualFailedReason as R,DefaultClientScope as c,ErrorType as g,EventName as m,FeatureClientScopeDict as _,FormCodeDict as A,MessageType as C,RefreshReason as p,ResetConversationContextualMode as O,ResetConverstationAction as N,ThemeMode as f}from"./constants.js";import{convertUserStatusToErrorType as M,checkUserStatusError as v,checkUserStatusChanged as y}from"./util.js";import{logEvent as I}from"./metrics.js";const u="customClientScopes",D="customAppendParams",U=`${s.endpoint}/edgesvc/chat`;export class HomePage extends t{static get properties(){return{isReady:{type:Boolean},isError:{type:Boolean},shellSig:{type:String},forceShowLoading:{type:Boolean}}}constructor(){super(),this.handleInitUserStatus=e=>{this.userStatus=e,this.errorType=v(this.userStatus),this.errorType!=g.NO_ERROR&&(this.isError=!0,a({type:C.SHOW_ERROR_PAGE,payload:{errorType:this.errorType}}))},this.refreshFrame=e=>{this.iframeReady=!1,this.isReady=!1,this.errorType=g.NO_ERROR,this.isError=!1,this.needRefresh=!1,this.shellSig=d(),this.lastRefreshTime=Date.now(),this.forceShowLoading=!1,this.isDiscoverV2&&this.updateComplete.then((()=>{this.showDiscoverShell()})),a({type:C.SHOW_LOADING_PAGE}),this.loadOverTime&&clearTimeout(this.loadOverTime),this.loadOverTime=setTimeout((()=>{this.isReady||this.onIframeError()}),2e4),e&&a({type:C.REFRESH,payload:{reason:e}})},this.onIframeLoad=()=>{this.iframeReady=!0;const e=this.iframeRef.value;try{const s=e.contentWindow,t=s?.initUserStatus||{};this.handleInitUserStatus(t)}catch(e){}},this.onIframeError=()=>{this.iframeReady=!1,this.isReady||this.isError||(this.errorType=g.E010002_LOAD_TIMEOUT,this.isError=!0,a({type:C.SHOW_ERROR_PAGE,payload:{errorType:g.E010002_LOAD_TIMEOUT}}))},this.onClickRetry=()=>{this.refreshFrame(p.REASON_CLICK),a({type:C.CLICK_RETRY_BUTTON})},this.dismissCopilotContainer=()=>{a({type:C.DISMISS_CHAT}),this.sendChatMessage({eventName:m.CONVERSATION_OPERATION,eventArgs:{action:"hide",isMobile:!0}})},this.getClientScopes=()=>{if(s[u])return s[u];const e=l[this.chatMode],t=Object.entries(s).filter((([e,s])=>e in _&&"true"===s)).map((([e,s])=>_[e])).filter(Boolean).join(",");return[c,e,t].filter(Boolean).join(",")+",mobarfe"},this.getFormCode=()=>{const s=this.launchSource||e(),t=A[this.chatMode]?.[s];return t?`&FORM=${t}`:""},this.getRpkey=()=>{const e=s.scenario,t=e?E[e]:"";return t?`&scenario=roleplaying&promptid=${t}`:""},this.lastRefreshTime=0,this.forceShowLoading=!1,this.chatMode="biz-chat"===s.chatMode?"biz-chat":"discover-chat",this.isDiscoverV2="true"===s["discover-v2"],this.launchSource=s.launchSource,this.resetConvOnServer="true"===s["reset-conv-on-server"],this.iframeRef=h();const t=window.matchMedia?.("(prefers-color-scheme: dark)");this.themeMode=t?.matches?f.DARK:f.LIGHT,t?.addEventListener("change",(e=>{this.themeMode=e.matches?f.DARK:f.LIGHT,this.sendChatMessage({eventName:m.THEME_CHANGE,eventArgs:{theme:this.themeMode}})})),this.refreshFrame()}showConversation(){this.isReady&&(this.sendChatMessage({eventName:m.CONVERSATION_OPERATION,eventArgs:{action:"show",isMobile:!0}}),this.showDiscoverShell())}triggerConsent(){this.isReady?(this.sendChatMessage({eventName:m.CONSENT_TRIGGER,eventArgs:{}}),this.consentTriggered=!0):this.hasConsentReqStashed=!0}resetConversation(){const e={eventName:m.CONVERSATION_OPERATION,eventArgs:{action:N,isMobile:!0,parameters:{mode:O}}};this.sendChatMessage(e)}firstUpdated(){window.addEventListener("message",this.onPostMessage.bind(this)),n((e=>{const{type:s,payload:t}=e;if(s===C.SEND_TO_CHAT)this.sendChatMessage(t);else if(s===C.SHOW_CHAT)this.isVisible=!0,this.isError||Math.abs(Date.now()-this.lastRefreshTime)>108e5||this.needRefresh?this.refreshFrame(p.REASON_AUTO):this.isReady?(this.showConversation(),a({type:C.CHAT_MESSAGE,payload:{eventName:m.FRAME_READY}})):this.showDiscoverShell();else if(s===C.DISMISS_CHAT)this.isVisible=!1;else if(s===C.DISMISS_CHAT_BY_NATIVE)this.hideDiscoverShell();else if(s===C.APP_ENTER_BACKGROUND)this.sendChatMessage({eventName:m.APP_STATE_CHANGE,eventArgs:{state:S.BACKGROUND}});else if(s===C.REFRESH)this.isVisible?this.refreshFrame(t?.eventArgs?.reason):this.needRefresh=!0;else if(s===C.SEND_SELECTED_TEXT_WITHOUT_CLIENT_CONSENT)this.triggerConsent(),this.lastSelectedMsg=t;else if(s===C.SET_INPUT_METHOD_INTO_CODEX){const e={eventName:m.CONVERSATION_OPERATION,eventArgs:t?.eventArgs};if(!this.isReady)return this.hasSetInputMethodStashed=!0,void(this.stashedSetInputMethodReq=e);this.sendChatMessage(e)}else if(s===C.SET_TONE_INTO_CODEX){const e={eventName:m.CONVERSATION_OPERATION,eventArgs:t?.eventArgs};if(!this.isReady)return this.hasSetToneStashed=!0,void(this.stashedSetToneReq=e);this.sendChatMessage(e)}else if(s===C.USER_STATUS){if(this.isReady||this.isError)return;this.errorType=M(t?.eventArgs),this.errorType!=g.NO_ERROR&&(this.isError=!0,a({type:C.SHOW_ERROR_PAGE,payload:{errorType:this.errorType}}))}else if(s===C.USER_STATUS_UPDATE){const e=t?.eventArgs;y(this.userStatus,e)&&this.refreshFrame(p.REASON_COOKIE)}else if(s===C.SEND_CAMERA_PERMISSION_RESULT){const e={eventName:m.SEND_CAMERA_PERMISSION_RESULT,eventArgs:t?.eventArgs};this.sendChatMessage(e)}else if(s===C.SEND_IMAGE_DATA){const e={eventName:m.SEND_IMAGE_DATA,eventArgs:{imageData:t?.eventArgs?.encodedImage}};this.sendChatMessage(e)}else if(s===C.RESET_AND_SEND_QUERY)if(this.isReady)this.resetConvOnServer?this.sendChatMessage(t):(this.resetConversation(),setTimeout((()=>{this.sendChatMessage(t)}),1e3));else{const e=setInterval((()=>{this.isReady&&(this.sendChatMessage(t),clearInterval(e))}),1e3)}else if(s===C.FORCE_SHOW_LOADING)this.forceShowLoading=!0;else if(s===C.CANCEL_FORCE_LOADING)this.forceShowLoading=!1;else if(s===C.SHOW_ERROR_PAGE){this.isError=!0;const e=t?.eventArgs?.errorType??g.E010000_DEFAULT_ERROR;this.errorType=e,a({type:C.SHOW_ERROR_PAGE,payload:{errorType:this.errorType}})}}))}sendCachedChatMessages(){if(!0===this.hasSetInputMethodStashed&&(this.sendChatMessage(this.stashedSetInputMethodReq),this.stashedSetInputMethodReq=void 0,this.hasSetInputMethodStashed=!1),!0===this.hasSetToneStashed&&(this.sendChatMessage(this.stashedSetToneReq),this.stashedSetToneReq=void 0,this.hasSetToneStashed=!1),!0===this.hasConsentReqStashed)return this.triggerConsent(),void(this.hasConsentReqStashed=!1);this.selectedMsg&&(this.sendChatMessage(this.selectedMsg),this.selectedMsg=void 0),this.tabChangeMsg&&(this.sendChatMessage(this.tabChangeMsg),this.tabChangeMsg=void 0)}onPostMessage(e){const s=e.data,{eventName:t,eventArgs:i}=s;if(t!==m.CIB_BASE_EXPERIENCE_READY)if(t!==m.INTERACT_REQUEST)if(t!==m.REFRESH)if(t!==m.SIGN_IN)if(t===m.DISCOVER_READY&&(this.isReady=!0,setTimeout((()=>this.sendCachedChatMessages()),300),this.sendChatMessage({eventName:m.THEME_CHANGE,eventArgs:{theme:this.themeMode}})),t!==m.CONVERSATION_EXIT){if(t===m.SELECT_TEXT_FAILED){const e=i?.data?.reason;e===R.REASON_CONSENT&&this.triggerConsent()}if(t===m.CONSENT_SET){if(i.text===T.ACCEPTED&&this.lastSelectedMsg&&!0===this.consentTriggered){const e=this.lastSelectedMsg;setTimeout((()=>{this.sendChatMessage(e)}),500)}this.lastSelectedMsg=null,this.consentTriggered=!1}if(t===m.SET_INPUT_METHOD)return"KeyboardFocus"===i?.data?.action?void window.scrollTo(0,document.body.scrollHeight):void a({type:C.SET_INPUT_METHOD_INTO_EDGE,payload:s});if(t!==m.REQUEST_CAMERA_PERMISSION)if(t!==m.REQUEST_CAMERA_UPLOAD){if(t===m.USER_STATUS_INIT){const e=i||{};this.handleInitUserStatus(e)}I(t,i),a({type:C.CHAT_MESSAGE,payload:s})}else a({type:C.REQUEST_CAMERA_UPLOAD,payload:s});else a({type:C.REQUEST_CAMERA_PERMISSION,payload:s})}else a({type:C.DISMISS_CHAT});else a({type:C.SIGN_IN});else this.refreshFrame(p.REASON_AUTO);else this.sendChatMessage({eventName:m.INTERACT_RESPONSE,eventArgs:{status:!!i.status}});else this.isReady=!0}sendChatMessage(e){const s=e.eventName;if(!this.isReady){if(s===m.SELECTED_TEXT)return void(this.selectedMsg=e);if(s===m.TAB_CHANGE)return void(this.tabChangeMsg=e)}s===m.SELECTED_TEXT&&(this.lastSelectedMsg=e);const t=this.iframeRef.value;t.contentWindow?.postMessage(e,U)}renderLoadingPage(){return i`<loading-page></loading-page>`}renderErrorPage(){return i`<error-page
        .errorType=${this.errorType}
        .onDismiss=${this.hideDiscoverShell}
        .onRetry=${this.onClickRetry}></error-page>`}renderDiscoverPage(){const e=!this.isError&&this.isReady&&!this.forceShowLoading;return i`
      <iframe ${o(this.iframeRef)} id='chat' name='chat' scrolling='no' style=${r({opacity:e?"1":"0"})} allow=${"clipboard-write;microphone;camera;autoplay;geolocation"} src=${this.combineChatUrl()} @load=${this.onIframeLoad} @error=${this.onIframeError}></iframe>
    `}combineChatUrl(){let e=`${U}?udsframed=1&clientscopes=${this.getClientScopes()}&shellsig=${this.shellSig}&${this.themeMode}=1${this.getFormCode()}${this.getRpkey()}`;return this.getClientScopes().includes("mobatos")&&(e+="&scenario=autosummarize&promptid=1000"),s[D]&&(e+=`&${s[D]}`),e}}