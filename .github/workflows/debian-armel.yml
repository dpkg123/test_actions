name: build debian11 armel rootfs

on:

  workflow_dispatch:

jobs:
  build-rootfs:
    runs-on: ubuntu-20.04
    permissions:
      contents: write
    steps:

    - name: "Checkout Repo"
      uses: actions/checkout@v4
      
    - name: Prepare the environment
      run: |
        sudo apt update 
        sudo apt install qemu-user-static debootstrap cpio

    - name: Build Rootfs
      run: |
        sudo debootstrap --arch=armel --include=icewm,xinit,w3m,htop,neofetch,ffmpeg,mpv,dos2unix,sl bullseye rootfs https://mirrors.bfsu.edu.cn/debian

    - name: Configure Rootfs
      run: |
        sudo test -d /etc/resolv.conf || sudo cp /etc/resolv.conf rootfs/etc/ -rv
        sudo rm -rf -v rootfs/etc/hostname
        sudo echo "Nintendo3DS" > rootfs/etc/hostname
        cd rootfs && sudo find -name qemu-* -delete
        
    - name: Package Rootfs
      run: |
        cd rootfs
        sudo find ./* | sudo cpio -oc > rootfs.cpio

    - name: Upload rootfs.cpio to Artifact
      uses: actions/upload-artifact@v3
      with: 
       name: "3ds-rootfs"
       path: rootfs.cpio
