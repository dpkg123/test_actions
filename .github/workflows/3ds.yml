name: build 3ds rootfs

on:

  workflow_dispatch:

jobs:
  build-3ds-rootfs:
    runs-on: ubuntu-20.04
    permissions:
      contents: write
    steps:

    - name: "Checkout Repo"
      uses: actions/checkout@v4
      
    # Cleanup The Actions Workspace Using Custom Composite Run Actions
    - name: Cleanup
      uses: rokibhasansagar/slimhub_actions@main
      # That's it! Now use your normal steps

    - name: Get Buildroot source
      run: |
        git clone https://github.com/linux-3ds/buildroot.git --depth=1

    - name: Set Swap Space
      uses: pierotofy/set-swap-space@master
      with:
        swap-size-gb: 8

    - run: |
        sudo apt-get install -y binutils build-essential git flex bison libssl-dev bc libgmp-dev subversion libmpc-dev
    - run: cp 3ds_defconfig buildroot/configs/nintendo3ds_defconfig
    - name: Build
      run: |
        cd buildroot
        make nintendo3ds_defconfig
        make all -j4
        
    - name: Upload rootfs to Artifact
      if: github.event_name == 'push'
      uses: actions/upload-artifact@v3
      with: 
       name: "3ds-rootfs"
       path: buildroot/output/images/rootfs.cpio.gz
