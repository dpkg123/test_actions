name: Build-kernel
on:
  push:
  workflow_dispatch:

jobs:
  ci-1:
    needs:
      - ci-3
      - ci-4
      - ci-6
    uses: ./.github/workflows/debian-armel.yml
    secrets: inherit
  ci-2:
   needs:
     - ci-5
     - ci-6
     - ci-3
   uses: ./.github/workflows/3ds.yml
   secrets: inherit
  ci-3:
   needs: 
     - ci-5
     - ci-4
   uses: ./.github/workflows/devuan-armel.yml
   secrets: inherit

  ci-4:
    needs: ci-6
    runs-on: ubuntu-20.04
    permissions:
      contents: read
    steps:

    - name: "Checkout Repo"
      run: git clone https://github.com/Mangeshrex/rxfetch
    - run: cd rxfetch && sudo bash rxfetch

  ci-6:
    runs-on: ubuntu-latest
    steps:
    - name: free disk space
      uses: rokibhasansagar/slimhub_actions@main
    - run: sudo apt-get update && sudo apt-get install gawk wget git-core diffstat unzip texinfo gcc-multilib \
           build-essential chrpath socat cpio python python3 python3-pip python3-pexpect \
           debianutils xz-utils iputils-ping python3-git python3-jinja2 libegl1-mesa libsdl1.2-dev xterm -y
    - run: git clone -b warrior git://git.yoctoproject.org/poky.git --depth=2
    - name: Build
      run: |
        cd poky
        source oe-init-build-env
        bitbake core-image-sato
    - run: sudo du -h poky/build


  ci-5:
    needa: ci-6
    runs-on: ubuntu-20.04
    permissions:
      contents: read
    steps:
    - name: free disk space
      uses: rokibhasansagar/slimhub_actions@main

    - run: sudo df -h

    - name: rm swapfile
      run: |
         export SWAP_FILE=$(swapon --show=NAME | tail -n 1)
         sudo swapoff $SWAP_FILE
         sudo rm $SWAP_FILE
         export ROOT_FREE_KB=$(df --block-size=1024 --output=avail / | tail -1)
         export ROOT_LOOP_KB=$(expr $ROOT_FREE_KB - 1048576)
         export ROOT_LOOP_BYTES=$(expr $ROOT_LOOP_KB \* 1024)
         sudo fallocate -l $ROOT_LOOP_BYTES /root.img
         export ROOT_LOOP_DEVNAME=$(sudo losetup -Pf --show /root.img)
         sudo pvcreate -f $ROOT_LOOP_DEVNAME
         export MNT_FREE_KB=$(df --block-size=1024 --output=avail /mnt | tail -1)
         export MNT_LOOP_KB=$(expr $MNT_FREE_KB - 102400)
         export MNT_LOOP_BYTES=$(expr $MNT_LOOP_KB \* 1024)
         sudo fallocate -l $MNT_LOOP_BYTES /mnt/mnt.img
         export MNT_LOOP_DEVNAME=$(sudo losetup -Pf --show /mnt/mnt.img)
         sudo pvcreate -f $MNT_LOOP_DEVNAME
         sudo vgcreate vgstorage $ROOT_LOOP_DEVNAME $MNT_LOOP_DEVNAME
         sudo lvcreate -n lvstorage -l 100%FREE vgstorage
         export LV_DEVNAME=$(sudo lvscan | awk -F "'" '{print $2}')
         sudo mkfs.btrfs -L combinedisk $LV_DEVNAME
         sudo mount -o compress=zstd $LV_DEVNAME $GITHUB_WORKSPACE
         sudo chown -R runner:runner $GITHUB_WORKSPACE
         mkdir -p $GITHUB_WORKSPACE/tmp && chmod 777 $GITHUB_WORKSPACE/tmp
         sudo cp -rp /tmp/* $GITHUB_WORKSPACE/tmp
         sudo mount -B $GITHUB_WORKSPACE/tmp /tmp && df -hT

    - run: sudo df -h
